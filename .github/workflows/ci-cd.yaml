name: CI/CD Pipeline

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, labeled]

env:
  HARBOR_URL: ${{ secrets.HARBOR_URL }}
  HARBOR_PROJECT: ${{ secrets.HARBOR_PROJECT }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed services
        id: set-matrix
        run: |
          # Find directories ending with 'service' that have changes
          CHANGED_SERVICES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '.*service/' | awk -F/ '{print $1}' | sort | uniq | grep 'service$')
          
          # Convert to JSON array with service type detection
          JSON_ARRAY="[]"
          first=true
          for service in $CHANGED_SERVICES; do
            if [ -d "$service" ]; then
              # Detect service type
              if [ -f "$service/go.mod" ]; then
                service_type="go"
              elif [ -f "$service/pom.xml" ]; then
                service_type="java"
              else
                echo "Warning: Cannot detect build type for $service, skipping..."
                continue
              fi
              
              if [ "$first" = true ]; then
                JSON_ARRAY="["
                first=false
              else
                JSON_ARRAY="$JSON_ARRAY,"
              fi
              JSON_ARRAY="$JSON_ARRAY{\"name\":\"$service\",\"type\":\"$service_type\"}"
            fi
          done
          
          if [ "$first" = false ]; then
            JSON_ARRAY="$JSON_ARRAY]"
          fi
          
          echo "Detected changed services: $JSON_ARRAY"
          
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
          if [ "$JSON_ARRAY" == "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      # Setup Java for Java-based services
      - name: Set up JDK 21
        if: matrix.service.type == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      # Setup Go for Go-based services
      - name: Set up Go
        if: matrix.service.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.service.name }}/go.sum
          
      # Build Java service
      - name: Build Java service with Maven
        if: matrix.service.type == 'java'
        run: |
          # Build the specific service
          ./mvnw clean package -pl ${{ matrix.service.name }} -am -DskipTests
      
      # Build Go service
      - name: Build Go service
        if: matrix.service.type == 'go'
        run: |
          cd ${{ matrix.service.name }}
          go mod download
          go build -v ./...
          
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
          
      - name: Build and Push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          SERVICE_NAME=${{ matrix.service.name }}
          # Check if Dockerfile exists in service directory
          if [ -f "$SERVICE_NAME/Dockerfile" ]; then
             # Build from root context
             docker build -f $SERVICE_NAME/Dockerfile -t $HARBOR_URL/$HARBOR_PROJECT/$SERVICE_NAME:$IMAGE_TAG .
             docker push $HARBOR_URL/$HARBOR_PROJECT/$SERVICE_NAME:$IMAGE_TAG
          else
             echo "No Dockerfile found for $SERVICE_NAME"
             exit 1
          fi

  deploy:
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.has_changes == 'true' && contains(github.event.pull_request.labels.*.name, 'cd')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
          
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Deploy to K8s
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config
          
          IMAGE_TAG=${{ github.sha }}
          SERVICE_NAME=${{ matrix.service.name }}
          
          helm upgrade --install $SERVICE_NAME ./deploy/charts/microservice \
            --set image.repository=$HARBOR_URL/$HARBOR_PROJECT/$SERVICE_NAME \
            --set image.tag=$IMAGE_TAG \
            --set fullnameOverride=$SERVICE_NAME
