name: CI/CD Pipeline

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Deploy only (skip CI)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      services:
        description: 'Services to deploy (comma-separated, e.g., user-service,gateway-service). Leave empty to deploy all changed services.'
        required: false
        type: string
      image_tag:
        description: 'Image tag to deploy (default: current commit SHA)'
        required: false
        type: string

env:
  HARBOR_URL: ${{ secrets.HARBOR_URL }}
  HARBOR_PROJECT: ${{ secrets.HARBOR_PROJECT }}
  HARBOR_CHART_PROJECT: ${{ secrets.HARBOR_CHART_PROJECT }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
      image_tag: ${{ steps.set-matrix.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display workflow inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Workflow Inputs ==="
          echo "Deploy only: ${{ github.event.inputs.deploy_only }}"
          echo "Services: ${{ github.event.inputs.services }}"
          echo "Image tag: ${{ github.event.inputs.image_tag }}"
          echo "======================="

      - name: Get changed services
        id: set-matrix
        run: |
          # Determine image tag based on mode
          # For deploy_only mode, use custom tag or SHA; otherwise always use SHA
          if [ "${{ github.event.inputs.deploy_only }}" == "true" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
            if [ -n "$IMAGE_TAG" ]; then
              # Validate image tag format: alphanumeric, dots, hyphens, underscores only
              if ! echo "$IMAGE_TAG" | grep -qE '^[a-zA-Z0-9._-]+$'; then
                echo "Error: Invalid image tag format. Only alphanumeric characters, dots, hyphens, and underscores are allowed."
                exit 1
              fi
              echo "Using custom image tag for deployment: $IMAGE_TAG"
            else
              IMAGE_TAG="${{ github.sha }}"
              echo "Using commit SHA for deployment: $IMAGE_TAG"
            fi
          else
            # Non-deploy-only mode: always use commit SHA (will build new image)
            IMAGE_TAG="${{ github.sha }}"
            echo "Using commit SHA for build and deployment: $IMAGE_TAG"
          fi
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          # If manual trigger, handle service selection
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.services }}" ]; then
              echo "Manual trigger with specified services: ${{ github.event.inputs.services }}"
              SERVICES="${{ github.event.inputs.services }}"
              
              # Validate services input format
              if ! echo "$SERVICES" | grep -qE '^[a-zA-Z0-9_,-]+$'; then
                echo "Error: Invalid services format. Only alphanumeric characters, hyphens, underscores, and commas are allowed."
                exit 1
              fi
              
              # Convert comma-separated services to JSON array
              JSON_ARRAY="["
              first=true
              valid_services_count=0
              IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
              
              for service in "${SERVICE_ARRAY[@]}"; do
                service=$(echo "$service" | xargs)  # Trim whitespace
                
                if [ -z "$service" ]; then
                  echo "Warning: Empty service name, skipping..."
                  continue
                fi
                
                if [ ! -d "$service" ]; then
                  echo "Error: Service directory not found: $service"
                  echo "Available services:"
                  for dir in *-service; do
                    if [ -d "$dir" ]; then
                      echo "  - $dir"
                    fi
                  done
                  exit 1
                fi
                
                # Detect service type
                if [ -f "$service/go.mod" ]; then
                  service_type="go"
                elif [ -f "$service/pom.xml" ]; then
                  service_type="java"
                else
                  echo "Error: Cannot detect build type for $service (no go.mod or pom.xml found)"
                  exit 1
                fi
                
                if [ "$first" = true ]; then
                  first=false
                else
                  JSON_ARRAY="$JSON_ARRAY,"
                fi
                JSON_ARRAY="$JSON_ARRAY{\"name\":\"$service\",\"type\":\"$service_type\"}"
                valid_services_count=$((valid_services_count + 1))
                echo "✓ Validated service: $service (type: $service_type)"
              done
              JSON_ARRAY="$JSON_ARRAY]"
              
              if [ "$valid_services_count" -eq 0 ]; then
                echo "Error: No valid services specified"
                exit 1
              fi
              
              echo "Using $valid_services_count specified service(s): $JSON_ARRAY"
              echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "${{ github.event.inputs.deploy_only }}" == "true" ]; then
              # Deploy-only mode without specified services - list available services
              echo "Deploy-only mode activated but no services specified."
              echo "Available services:"
              for dir in *-service; do
                if [ -d "$dir" ]; then
                  echo "  - $dir"
                fi
              done
              echo "Please specify services in the workflow input."
              echo "matrix=[]" >> $GITHUB_OUTPUT
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Otherwise, detect changed services from git diff
          echo "Auto-detecting changed services from git diff..."
          
          # Ensure base branch is available for diff (PR uses base_ref, manual defaults to main)
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
          fi
          echo "Comparing against base branch: $BASE_REF"
          git fetch origin "$BASE_REF" --depth=1

          # Find directories ending with 'service' that have changes
          CHANGED_SERVICES=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '.*service/' | awk -F/ '{print $1}' | sort | uniq | grep 'service$' || true)
          
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No service changes detected"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Changed services detected:"
          echo "$CHANGED_SERVICES"
          
          # Convert to JSON array with service type detection
          JSON_ARRAY="["
          first=true
          valid_services_count=0
          
          for service in $CHANGED_SERVICES; do
            if [ ! -d "$service" ]; then
              echo "Warning: Service directory not found: $service, skipping..."
              continue
            fi
            
            # Detect service type
            if [ -f "$service/go.mod" ]; then
              service_type="go"
            elif [ -f "$service/pom.xml" ]; then
              service_type="java"
            else
              echo "Warning: Cannot detect build type for $service (no go.mod or pom.xml found), skipping..."
              continue
            fi
            
            if [ "$first" = true ]; then
              first=false
            else
              JSON_ARRAY="$JSON_ARRAY,"
            fi
            JSON_ARRAY="$JSON_ARRAY{\"name\":\"$service\",\"type\":\"$service_type\"}"
            valid_services_count=$((valid_services_count + 1))
            echo "✓ Added service: $service (type: $service_type)"
          done
          JSON_ARRAY="$JSON_ARRAY]"
          
          if [ "$valid_services_count" -eq 0 ]; then
            echo "No valid services found after filtering"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Total $valid_services_count valid service(s) with changes: $JSON_ARRAY"
            echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  test:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_only != 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      # Setup Java for Java-based services
      - name: Set up JDK 21
        if: matrix.service.type == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      # Setup Go for Go-based services
      - name: Set up Go
        if: matrix.service.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.service.name }}/go.sum

      # Test Java service
      - name: Test Java service with Maven
        if: matrix.service.type == 'java'
        working-directory: ${{ matrix.service.name }}
        run: |
          chmod +x mvnw
          ./mvnw test
      
      # Test Go service
      - name: Test Go service
        if: matrix.service.type == 'go'
        run: |
          cd ${{ matrix.service.name }}
          go mod download
          go test ./...

  build-and-push:
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.has_changes == 'true' && 
      (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_only != 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      max-parallel: 1
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      # Setup Java for Java-based services
      - name: Set up JDK 21
        if: matrix.service.type == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      # Setup Go for Go-based services
      - name: Set up Go
        if: matrix.service.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.service.name }}/go.sum
          
      # Build Java service
      - name: Build Java service with Maven
        if: matrix.service.type == 'java'
        working-directory: ${{ matrix.service.name }}
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests
      
      # Build Go service
      - name: Build Go service
        if: matrix.service.type == 'go'
        run: |
          cd ${{ matrix.service.name }}
          go mod download
          go build -v ./...
          
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
          
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service.name }}/Dockerfile
          push: true
          tags: ${{ secrets.HARBOR_URL }}/${{ secrets.HARBOR_PROJECT }}/${{ matrix.service.name }}:${{ needs.detect-changes.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Push Helm chart to Harbor
        run: |
          SERVICE_NAME=${{ matrix.service.name }}
          CHART_DIR=./deploy/charts/$SERVICE_NAME
          if [ ! -d "$CHART_DIR" ]; then
            echo "No Helm chart found for $SERVICE_NAME at $CHART_DIR, skip chart push."
            exit 0
          fi

          helm registry login $HARBOR_URL -u "${{ secrets.HARBOR_CHART_USERNAME }}" -p "${{ secrets.HARBOR_CHART_PASSWORD }}"

          VERSION="0.0.${{ github.run_number }}"
          APP_VERSION="${{ needs.detect-changes.outputs.image_tag }}"
          PACKAGE_PATH=$(helm package "$CHART_DIR" --version "$VERSION" --app-version "$APP_VERSION" | awk -F': ' '{print $2}')
          if [ -z "$PACKAGE_PATH" ]; then
            echo "Failed to package chart for $SERVICE_NAME"
            exit 1
          fi

          helm push "$PACKAGE_PATH" "oci://$HARBOR_URL/$HARBOR_CHART_PROJECT"

  deploy:
    needs: [detect-changes]
    if: github.event_name == 'workflow_dispatch' && (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.deploy_only == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      max-parallel: 1
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
          
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Deploy to K8s
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          printf '%s' "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Use image tag from detect-changes output (which handles input or default to SHA)
          IMAGE_TAG="${{ needs.detect-changes.outputs.image_tag }}"
          SERVICE_NAME=${{ matrix.service.name }}
          
          echo "Deploying $SERVICE_NAME with image tag: $IMAGE_TAG"
          
          helm upgrade --install $SERVICE_NAME ./deploy/charts/$SERVICE_NAME \
            --set image.repository=$HARBOR_URL/$HARBOR_PROJECT/$SERVICE_NAME \
            --set image.tag=$IMAGE_TAG \
            --set fullnameOverride=$SERVICE_NAME
