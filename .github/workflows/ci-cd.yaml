name: CI/CD Pipeline

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, labeled]

env:
  HARBOR_URL: ${{ secrets.HARBOR_URL }}
  HARBOR_PROJECT: ${{ secrets.HARBOR_PROJECT }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed services
        id: set-matrix
        run: |
          # Find directories ending with 'service' that have changes
          CHANGED_SERVICES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '.*service/' | awk -F/ '{print $1}' | sort | uniq | grep 'service$')
          
          # Convert to JSON array
          JSON_ARRAY="["
          first=true
          for service in $CHANGED_SERVICES; do
            if [ -d "$service" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                JSON_ARRAY="$JSON_ARRAY,"
              fi
              JSON_ARRAY="$JSON_ARRAY\"$service\""
            fi
          done
          JSON_ARRAY="$JSON_ARRAY]"
          
          echo "Detected changed services: $JSON_ARRAY"
          
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT
          if [ "$JSON_ARRAY" == "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          
      - name: Build with Maven
        run: |
          # Build the specific service (and dependencies if necessary)
          # Assuming root pom can build everything or we build individually
          # If we run from root with -pl, it builds specific module
          ./mvnw clean package -pl ${{ matrix.service }} -am -DskipTests
          # Run tests separately or part of package. User requested "check", so we should run tests.
          # ./mvnw test -pl ${{ matrix.service }} -am
          
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
          
      - name: Build and Push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          # Check if Dockerfile exists in service directory
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then
             # Build from root context
             docker build -f ${{ matrix.service }}/Dockerfile -t $HARBOR_URL/$HARBOR_PROJECT/${{ matrix.service }}:$IMAGE_TAG .
             docker push $HARBOR_URL/$HARBOR_PROJECT/${{ matrix.service }}:$IMAGE_TAG
          else
             echo "No Dockerfile found for ${{ matrix.service }}"
             exit 1
          fi

  deploy:
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.has_changes == 'true' && contains(github.event.pull_request.labels.*.name, 'cd')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
          
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Deploy to K8s
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config
          
          IMAGE_TAG=${{ github.sha }}
          
          helm upgrade --install ${{ matrix.service }} ./deploy/charts/microservice \
            --set image.repository=$HARBOR_URL/$HARBOR_PROJECT/${{ matrix.service }} \
            --set image.tag=$IMAGE_TAG \
            --set fullnameOverride=${{ matrix.service }}
