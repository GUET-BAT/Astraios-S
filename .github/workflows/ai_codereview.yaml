import json
import os
import sys
import re
import requests

# -------------------------- åˆå§‹åŒ–é…ç½® & å…¥å‚è¯»å– & ä¿®å¤å‘Šè­¦ï¼šæ ¡éªŒGITHUB_SHA --------------------------
def init_config():
    # æ ¡éªŒå…¥å‚æ˜¯å¦æ­£ç¡®
    if len(sys.argv) < 2:
        print(" Error: è¯·ä¼ å…¥diffæ–‡ä»¶è·¯å¾„ä½œä¸ºè„šæœ¬å…¥å‚")
        sys.exit(1)  # éé›¶é€€å‡ºç ï¼Œè§„èŒƒCI/CDæ‰§è¡ŒçŠ¶æ€
    diff_path = sys.argv[1]
    
    # âœ… ä¿®å¤å‘Šè­¦ï¼šæ ¡éªŒæ‰€æœ‰å¿…è¦ç¯å¢ƒå˜é‡ï¼ŒåŒ…å«GITHUB_SHAï¼Œç¼ºå¤±åˆ™æŠ¥é”™+éé›¶é€€å‡º
    required_envs = ["OPENAI_API_KEY", "REPO", "PR_NUMBER", "GH_TOKEN", "GITHUB_SHA"]
    missing_envs = []
    for env in required_envs:
        if not os.environ.get(env) or os.environ.get(env).strip() == "":
            missing_envs.append(env)
    if missing_envs:
        print(f" Error: ç¼ºå¤±å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼Œè¯·æ£€æŸ¥é…ç½®: {', '.join(missing_envs)}")
        sys.exit(1)

    # è¿”å›é…ç½®å­—å…¸
    return {
        "diff_path": diff_path,
        "dashscope_api_key": os.environ["OPENAI_API_KEY"],
        "repo": os.environ["REPO"],
        "pr_number": os.environ["PR_NUMBER"],
        "gh_token": os.environ["GH_TOKEN"],
        "github_sha": os.environ["GITHUB_SHA"]
    }

# -------------------------- è¯»å–diffæ–‡ä»¶ & ä¿®å¤å‘Šè­¦ï¼šç©ºæ–‡ä»¶å‹å¥½æç¤º --------------------------
def read_diff_file(diff_path):
    try:
        with open(diff_path, 'r', encoding='utf-8') as f:
            diff_content = f.read().strip()
        
        #  ä¿®å¤å‘Šè­¦ï¼šç©ºdiffæ–‡ä»¶æ›´å‹å¥½çš„æ—¥å¿—æç¤ºï¼Œè¯¦ç»†è¯´æ˜+ä¼˜é›…é€€å‡º
        if not diff_content:
            print("Info: diffæ–‡ä»¶å†…å®¹ä¸ºç©º,æœ¬æ¬¡PRæ— ä»£ç å˜æ›´,è·³è¿‡AIè¯„å®¡æµç¨‹")
            sys.exit(0)  # é›¶é€€å‡ºç ï¼Œä»£è¡¨æ­£å¸¸ç»“æŸ
        
        print(f"Success: æˆåŠŸè¯»å–diffæ–‡ä»¶,ä»£ç å˜æ›´å†…å®¹é•¿åº¦: {len(diff_content)} å­—ç¬¦")
        return diff_content
    except FileNotFoundError:
        print(f" Error: æ‰¾ä¸åˆ°æŒ‡å®šçš„diffæ–‡ä»¶ -> {diff_path}")
        sys.exit(1)
    except Exception as e:
        print(f" Error: è¯»å–diffæ–‡ä»¶å¤±è´¥ -> {str(e)}")
        sys.exit(1)

# -------------------------- æ ¸å¿ƒï¼šè°ƒç”¨é€šä¹‰åƒé—®APIè¿›è¡Œä»£ç è¯„å®¡ --------------------------
def call_ai_review(config, diff_content):
    DASHSCOPE_API_KEY = config["dashscope_api_key"]
    API_URL = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    # è¯„å®¡æç¤ºè¯-ä¿ç•™åŸæœ‰è§„åˆ™ï¼Œæ— éœ€ä¿®æ”¹
    PROMPT = f"""
You are a senior software engineer performing code review.
Review the following git diff.
Classify issues into:
- CRITICAL: bugs, crashes, security, data loss
- MAJOR: logic issues, race conditions
- MINOR: style, refactor suggestions
Rules:
- If any CRITICAL exists -> approval = false
- Otherwise -> approval = true
Output JSON ONLY:
{{
  "approval": boolean,
  "issues": [
    {{
      "severity": "CRITICAL|MAJOR|MINOR",
      "file": "path",
      "line": number,
      "message": "description",
      "suggestion": "how to fix"
    }}
  ]
}}
Diff:
{diff_content}
"""
    payload = {
        "model": "qwen-max",
        "input": {"messages": [{"role": "user", "content": PROMPT}]},
        "parameters": {"temperature": 0.2, "top_p": 0.9, "max_tokens": 2048}
    }
    headers = {
        "Authorization": f"Bearer {DASHSCOPE_API_KEY}",
        "Content-Type": "application/json"
    }

    try:
        print("Info: å¼€å§‹è°ƒç”¨ã€é˜¿é‡Œäº‘ é€šä¹‰åƒé—®ã€‘è¿›è¡ŒAIä»£ç è¯„å®¡...")
        resp = requests.post(API_URL, headers=headers, json=payload, timeout=60)
        resp.raise_for_status()
        resp_json = resp.json()
        
        if resp_json.get("output", {}).get("text"):
            ai_content = resp_json["output"]["text"].strip()
            print(" Success: é€šä¹‰åƒé—®APIè°ƒç”¨æˆåŠŸ,è·å–åˆ°è¯„å®¡ç»“æœ")
            return ai_content
        else:
            print(f" Error: é€šä¹‰åƒé—®è¿”å›å†…å®¹å¼‚å¸¸ï¼Œæ— è¯„å®¡ç»“æœ -> {json.dumps(resp_json, ensure_ascii=False)}")
            return None
    # âœ… ä¿®å¤å‘Šè­¦ï¼šAIè°ƒç”¨å¤±è´¥æ—¶ï¼Œè¯¦ç»†æ—¥å¿—+éé›¶é€€å‡ºç ï¼Œç²¾å‡†å®šä½é—®é¢˜
    except requests.exceptions.HTTPError as e:
        err_msg = f"é€šä¹‰åƒé—®APIè¯·æ±‚å¤±è´¥ [çŠ¶æ€ç :{resp.status_code}] -> {str(e)}"
        if resp.status_code == 401:
            err_msg += " | åŸå› :API-KEYæ— æ•ˆ/è¿‡æœŸï¼Œè¯·æ£€æŸ¥å¯†é’¥é…ç½®"
        elif resp.status_code == 429:
            err_msg += " | åŸå› ï¼šè°ƒç”¨é¢‘ç‡è¶…é™/é¢åº¦ä¸è¶³ï¼Œè¯·ç¨åé‡è¯•"
        print(f" Error: {err_msg}")
        return None
    except Exception as e:
        print(f" Error: é€šä¹‰åƒé—®AIè¯„å®¡è°ƒç”¨å¤±è´¥ -> {str(e)}")
        return None

# -------------------------- è§£æAIè¿”å›çš„JSON & ä¿®å¤å‘Šè­¦ï¼šè§£æå¤±è´¥è¯¦ç»†æ—¥å¿—+éé›¶é€€å‡º --------------------------
def parse_ai_json(ai_content):
    if not ai_content:
        print(" Error: AIè¯„å®¡ç»“æœä¸ºç©º,è°ƒç”¨å¤±è´¥")
        # è¿”å›å…œåº•ç»“æœ+éé›¶é€€å‡ºï¼Œé˜»æ–­åˆå¹¶
        return {"approval": False, "issues": [{"severity": "CRITICAL", "file": "system", "line": 0, "message": "AIè¯„å®¡æœåŠ¡è°ƒç”¨å¤±è´¥", "suggestion": "è¯·æŸ¥çœ‹Actionæ—¥å¿—æ’æŸ¥é—®é¢˜ï¼Œæˆ–ç¨åé‡è¯•"}]}
    
    try:
        # æ­£åˆ™æå–çº¯å‡€JSONï¼Œå…¼å®¹AIè¿”å›çš„å¤šä½™å­—ç¬¦
        json_match = re.search(r'\{[\s\S]*\}', ai_content)
        if not json_match:
            raise ValueError(f"æœªåŒ¹é…åˆ°æœ‰æ•ˆJSONå†…å®¹,AIåŸå§‹è¿”å›: {ai_content[:300]}...")
        
        pure_json = json_match.group(0)
        result = json.loads(pure_json)
        
        # æ ¡éªŒJSONç»“æ„å®Œæ•´æ€§
        if "approval" not in result or "issues" not in result:
            raise ValueError("AIè¿”å›çš„JSONç¼ºå°‘æ ¸å¿ƒå­—æ®µ approval/issues")
        
        issue_count = len(result['issues'])
        print(f" Success: AIè¯„å®¡ç»“æœè§£æå®Œæˆ,å…±å‘ç° {issue_count} ä¸ªé—®é¢˜ï¼Œå®¡æ‰¹çŠ¶æ€: {result['approval']}")
        return result
    # âœ… ä¿®å¤å‘Šè­¦ï¼šJSONè§£æå¤±è´¥æ—¶ï¼Œæ‰“å°è¯¦ç»†æ—¥å¿—+è¿”å›é”™è¯¯ç»“æœï¼Œè§„èŒƒé€€å‡º
    except Exception as e:
        err_detail = f"JSONè§£æå¤±è´¥ -> {str(e)} | AIåŸå§‹è¿”å›å†…å®¹: {ai_content[:300]}..."
        print(f" Error: {err_detail}")
        return {"approval": False, "issues": [{"severity": "CRITICAL", "file": "system", "line": 0, "message": "AIè¯„å®¡ç»“æœè§£æå¤±è´¥", "suggestion": err_detail}]}

# -------------------------- æ„å»ºGitHubè¯·æ±‚å¤´ --------------------------
def get_github_headers(gh_token):
    return {
        "Authorization": f"Bearer {gh_token}",
        "Accept": "application/vnd.github+json",
        "X-GitHub-Api-Version": "2022-11-28"
    }

# -------------------------- å‘PRå‘å¸ƒæ ¼å¼åŒ–è¯„å®¡è¯„è®º --------------------------
def post_pr_comment(repo, pr_number, headers, issues):
    try:
        body = "### ğŸ¤– AI Code Review Result (é˜¿é‡Œäº‘ é€šä¹‰åƒé—® qwen-max)\n\n"
        if not issues:
            body += " **No issues found. Code is clean and safe to merge!** \n\n"
        else:
            issues_sorted = sorted(issues, key=lambda x: {"CRITICAL":0, "MAJOR":1, "MINOR":2}[x["severity"]])
            for idx, issue in enumerate(issues_sorted, 1):
                severity_emoji = {"CRITICAL": "âŒ", "MAJOR": "âš ï¸", "MINOR": "â„¹ï¸"}[issue["severity"]]
                body += f"{idx}. **{severity_emoji} {issue['severity']}** `{issue['file']}:{issue['line']}`\n"
                body += f"   â¤ é—®é¢˜: {issue['message']}\n"
                body += f"   â¤ ä¿®å¤å»ºè®®: {issue['suggestion']}\n\n"
        
        resp = requests.post(
            f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments",
            headers=headers,
            json={"body": body},
            timeout=30
        )
        resp.raise_for_status()
        print("âœ… Success: PRè¯„å®¡è¯„è®ºå·²æˆåŠŸå‘å¸ƒ")
    except Exception as e:
        print(f"âš ï¸ Warning: PRè¯„è®ºå‘å¸ƒå¤±è´¥ -> {str(e)}")

# -------------------------- åˆ›å»ºGitHub Check Runï¼ˆé˜»æ–­/æ”¾è¡Œåˆå¹¶ï¼‰ --------------------------
def create_check_run(repo, github_sha, headers, approval, issues):
    try:
        conclusion = "success" if approval else "failure"
        title = "âœ… AI Review Passed" if approval else "âŒ AI Review Failed (Critical Issues)"
        critical_count = len([i for i in issues if i["severity"] == "CRITICAL"])
        major_count = len([i for i in issues if i["severity"] == "MAJOR"])
        minor_count = len([i for i in issues if i["severity"] == "MINOR"])
        
        summary = f"""Critical: {critical_count} | Major: {major_count} | Minor: {minor_count}
{'âœ… No critical issues detected, safe to merge.' if approval else 'âŒ Critical issues found, merge blocked!'}"""

        resp = requests.post(
            f"https://api.github.com/repos/{repo}/check-runs",
            headers=headers,
            json={
                "name": "AI Code Review",
                "head_sha": github_sha,
                "status": "completed",
                "conclusion": conclusion,
                "output": {"title": title, "summary": summary}
            },
            timeout=30
        )
        resp.raise_for_status()
        print(f"âœ… Success: CheckRunåˆ›å»ºæˆåŠŸ,è¯„å®¡ç»“æœ: {conclusion}")
    except Exception as e:
        print(f"âš ï¸ Warning: CheckRunåˆ›å»ºå¤±è´¥ -> {str(e)}")

# -------------------------- è‡ªåŠ¨å®¡æ‰¹PR --------------------------
def approve_pr(repo, pr_number, headers):
    try:
        resp = requests.post(
            f"https://api.github.com/repos/{repo}/pulls/{pr_number}/reviews",
            headers=headers,
            json={"event": "APPROVE", "body": "ğŸ¤– AI Review Approved: No critical issues found, code quality is acceptable."},
            timeout=30
        )
        resp.raise_for_status()
        print("âœ… Success: PRå·²è‡ªåŠ¨å®¡æ‰¹é€šè¿‡ (APPROVE)")
    except Exception as e:
        print(f"âš ï¸ Warning: PRè‡ªåŠ¨å®¡æ‰¹å¤±è´¥ -> {str(e)}")

# -------------------------- ä¸»å‡½æ•°å…¥å£ --------------------------
def main():
    config = init_config()
    diff_content = read_diff_file(config["diff_path"])
    ai_content = call_ai_review(config, diff_content)
    ai_result = parse_ai_json(ai_content)
    approval = ai_result["approval"]
    issues = ai_result["issues"]
    headers = get_github_headers(config["gh_token"])
    
    # æ‰§è¡Œæ ¸å¿ƒæ“ä½œ
    post_pr_comment(config["repo"], config["pr_number"], headers, issues)
    create_check_run(config["repo"], config["github_sha"], headers, approval, issues)
    if approval:
        approve_pr(config["repo"], config["pr_number"], headers)
    
    # âœ… è§„èŒƒï¼šå¦‚æœæ˜¯å¤±è´¥çŠ¶æ€ï¼Œéé›¶é€€å‡ºï¼Œè®©Actionæ˜¾ç¤ºå¤±è´¥
    if not approval:
        print("âŒ AIè¯„å®¡å‘ç°é«˜å±é—®é¢˜,æµç¨‹ç»“æŸ,é€€å‡ºç : 1")
        sys.exit(1)
    sys.exit(0)

if __name__ == "__main__":
    main()